#TrafficJam
<img src="https://github.com/zachliu/Insight-TrafficJam/blob/master/images/traffic.jpg" alt="alt text" width="640" height="400">


#Table of Contents
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#introduction">Introduction</a>
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#data-set">Data Set</a>
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#data-transformations">Data Transformations</a>
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#schemas">Schemas</a>
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#live-demo">Live Demo</a>
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#presentation-deck">Presentation Deck</a>
- <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/README.md#instructions-to-run-this-pipeline">Instructions to Run this Pipeline</a>


#Introduction
This is a data engineering project at Insight Data Science. There are two goals that this project aims to accomplish:
- Provide an API for drivers, city planners, and data scientists, for analyzing long term trends in traffic pattern w.r.t metrics such as average car volume, speed etc.
- Enable a framework for real-time monitoring of traffic information, so that a user can know the best route to take and select a specific road to view the historical data.

#Data Set
**Historical:**
The project is based on historical traffic volume data for nearly 60,000 major roads in New York State, collected over 10 years. The data is available as a time series. The following table provides a snap shot of the raw data set:

roadID, timestamp, car count

<img src="https://github.com/zachliu/Insight-TrafficJam/blob/master/images/rawdata.png" alt="alt text" width="272" height="143">

**Real-Time:**
The historical data set is played back to simulate real-time behavior.

**AWS Clusters:**
A distributed AWS cluster of four ec2 machines is being used for this project. All the components (ingestion, batch and real-time processing) are configured and run in distributed mode, with one master and 3 workers.

#Data Processing Framework
<img src="https://github.com/zachliu/Insight-TrafficJam/blob/master/images/pipeline.png" alt="alt text" width="600" height="254">

- **Ingestion Layer (Kafka):** The raw data is consumed by a message broker, configured in publish-subscribe mode. Related files: <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/kafka/producer.py">producer.py</a>, <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/kafka/kafka_consumer.py">kafka_consumer.py</a>.

- **Batch Layer (HDFS, Hadoop):** A kafka consumer stores the data into HDFS. Additional columns are added to the dataset to generate metrics as described in the ensuing section. This is accomplished using Hive (and MrJob). Following this, tables representing the aggregate views for serving queries at the user end are generated using Hive.

- **Serving Layer (Spark):** Datastore tables store the aggregate views for hour of day, day of week and individual cab profiles as generated by Hive. The table schema is optimized for quick access, by storing the hours as columns and the totals for each day in the same row (this way, hourly and daily profiles can be served from the same table/rows).

- **Speed Layer (Storm):** The topology for processing real-time data comprises of a kafka-spout and a bolt (with tick interval frequency of 5 sec). The data is filtered to only store currently available (unoccupied) cabs into HBase. In order to serve queries with low latency, all the data is stored in one row (maximum possible columns = number of cabs = 500). For future work, the data can be stored with the key as city, so that all cabs pertaining to a city can be retrieved via one row. If the number of cabs is large, further breakdown on city_zipcode (as key) will enable quick access, while retaining the advantage of quick row scans in HBase.

- **Front-end (Flask):** The cab locations are rendered on Google Maps and updated at 2 sec interval via AJAX. Historical data is represented as bar and line charts. Realted files: <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/flask/app/views.py">views.py</a>, <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/flask/app/static/batch.js">batch.js</a>, <a href="https://github.com/zachliu/Insight-TrafficJam/blob/master/flask/app/static/map.js">map.js</a>.

- **Libraries and APIs:** Cassandra, Pyleus, Kafka-python

#Data Transformations
Following metrics are computed via a MapReduce operation on the raw dataset (Spark):
- Total car count in a month
- Related Files: <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/spark/myBatch.py">myBatch.py</a>  

Table below displays the transformed data: RoadID (RoadID_timestamp), year, month, total car count

<img src="https://github.com/zachliu/Insight-TrafficJam/blob/master/images/triptable.png" alt="alt text" width="400" height="250">


#Schemas

**Batch Schema:**
The key for batch storage is organized as RoadID yyyymm.

<img src="https://github.com/zachliu/Insight-TrafficJam/blob/master/images/batchschema.png" alt="alt text" width="650" height="250">

**Streaming Data**
- The incoming data is filtered in real-time (simulated). The storm topology comprises of one spout (kafka integrated) and one bolt. The bolt operates on a tick interval of 2.5 sec to collect data for 2.5 seconds before pushing it to Cassandra.
- Related files: <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/Storm/cab_topology/cab_topology/stormBolt.py">stormBolt.py</a>, <a href= "https://github.com/zachliu/Insight-TrafficJam/blob/master/Storm/cab_topology/topology.yaml">topology.yaml</a>

#Live Demo:
A Live Demo of the project is available here: <a href= "http://trafficjam.today">trafficjam.today</a> or <a href= "http://trafficjam.online">trafficjam.online</a>. A snap shot of the map with highlighted roads:


<img src="https://github.com/zachliu/Insight-TrafficJam/blob/master/images/realtime.png" alt="alt text" width="707" height="542">

#Presentation
The presentation slides are available here:
<a href= "http://trafficjam.today/slideshare">trafficjam.today/slideshare</a>

#Instructions to Run this Pipeline

Install python packages:
```sudo pip install kafka-python cassandra-driver pyleus```

Run the Kafka producer:
```python kafka/producer.py```

Run the Kafka consumer:
```python kafka/kafka_consumer.py```

Run Spark:
```spark-submit --packages TargetHolding/pyspark-cassandra:0.1.5 ~/Insight-TrafficJam/spark/myBatch.py```


Build storm topology:
```pyleus build topology.yaml```

Submit pyleus topology:
```pyleus submit -n 54.174.177.48 topology.jar```






